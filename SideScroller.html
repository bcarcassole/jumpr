<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JUMPR</title>
<style>
    body {
        margin: 0;
        background: #0b0b0b;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: Arial, sans-serif;
    }
    canvas {
        border: 3px solid white;
    }
</style>
</head>
<body>

<canvas id="game" width="800" height="300"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ==================================================
// AUDIO (SAFE INITIALIZATION)
// ==================================================
let audioCtx = null;
let introMusic = null;
let gameMusic = null;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function stopMusic() {
    [introMusic, gameMusic].forEach(m => {
        if (m) {
            m.stop();
            clearInterval(m.interval);
        }
    });
    introMusic = gameMusic = null;
}

// Intro music
function startIntroMusic() {
    stopMusic();
    introMusic = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    introMusic.type = "triangle";
    gain.gain.value = 0.08;

    introMusic.connect(gain).connect(audioCtx.destination);
    introMusic.start();

    const notes = [220, 277, 330, 440];
    let i = 0;
    introMusic.interval = setInterval(() => {
        introMusic.frequency.setValueAtTime(notes[i % notes.length], audioCtx.currentTime);
        i++;
    }, 500);
}

// Gameplay music
function startGameMusic() {
    stopMusic();
    gameMusic = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    gameMusic.type = "sine";
    gain.gain.value = 0.06;

    gameMusic.connect(gain).connect(audioCtx.destination);
    gameMusic.start();

    gameMusic.interval = setInterval(() => {
        gameMusic.frequency.setValueAtTime(140 + Math.random() * 60, audioCtx.currentTime);
    }, 400);
}

// Jump sound
function playJumpSound() {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.frequency.setValueAtTime(250, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + 0.15);
    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);

    osc.connect(gain).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.2);
}

// Crash sound
function playCrashSound() {
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.2, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;

    const src = audioCtx.createBufferSource();
    const gain = audioCtx.createGain();
    gain.gain.value = 0.4;

    src.buffer = buffer;
    src.connect(gain).connect(audioCtx.destination);
    src.start();
}

// ==================================================
// GAME CONSTANTS
// ==================================================
const GROUND_Y = 220;
const GRAVITY = 0.45;
const JUMP_FORCE = -17;

// ==================================================
// STATE
// ==================================================
let gameStarted = false;
let gameOver = false;
let speed = 3;
let score = 0;
let time = 0;

// Player
const player = {
    x: 100,
    y: GROUND_Y,
    w: 40,
    h: 40,
    vy: 0,
    onGround: true
};

// Obstacles
const obstacleTypes = [
    { w: 30, h: 50, color: "#ff5c5c" },
    { w: 30, h: 80, color: "#5cc8ff" },
    { w: 60, h: 40, color: "#5cff8a" },
    { w: 50, h: 60, color: "#ffd35c" }
];

let obstacle = null;

function createObstacle() {
    const t = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
    return {
        x: canvas.width + 100,
        y: GROUND_Y + (player.h - t.h),
        w: t.w,
        h: t.h,
        color: t.color
    };
}

// ==================================================
// INPUT
// ==================================================
document.addEventListener("keydown", e => {
    if (e.code !== "Space") return;

    initAudio();

    if (!gameStarted) {
        gameStarted = true;
        resetGame();
        startGameMusic();
        return;
    }

    if (!gameOver && player.onGround) {
        player.vy = JUMP_FORCE;
        player.onGround = false;
        playJumpSound();
    } else if (gameOver) {
        resetGame();
        startGameMusic();
    }
});

function resetGame() {
    gameOver = false;
    score = 0;
    speed = 3;
    player.y = GROUND_Y;
    player.vy = 0;
    player.onGround = true;
    obstacle = createObstacle();
}

// ==================================================
// UPDATE
// ==================================================
function update() {
    time++;

    if (!gameStarted || gameOver) return;

    player.vy += GRAVITY;
    player.y += player.vy;

    if (player.y >= GROUND_Y) {
        player.y = GROUND_Y;
        player.vy = 0;
        player.onGround = true;
    }

    obstacle.x -= speed;

    if (obstacle.x + obstacle.w < player.x - 50) {
        score++;
        speed *= 1.05;
        obstacle = createObstacle();
    }

    if (
        player.x < obstacle.x + obstacle.w &&
        player.x + player.w > obstacle.x &&
        player.y < obstacle.y + obstacle.h &&
        player.y + player.h > obstacle.y
    ) {
        gameOver = true;
        stopMusic();
        playCrashSound();
        startIntroMusic();
    }
}

// ==================================================
// DRAW
// ==================================================
function drawStartScreen() {
    const grad = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
    grad.addColorStop(0, "#1b1f3b");
    grad.addColorStop(1, "#0f2027");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const bounce = Math.sin(time * 0.05) * 5;
    ctx.fillStyle = "#fff";
    ctx.font = "72px Arial Black";
    ctx.fillText("JUMPR", 260, 140 + bounce);

    ctx.font = "20px Arial";
    ctx.globalAlpha = 0.6 + Math.sin(time * 0.1) * 0.4;
    ctx.fillText("Press Spacebar to Start", 265, 190);
    ctx.globalAlpha = 1;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (!gameStarted) {
        drawStartScreen();
        return;
    }

    ctx.fillStyle = "#87ceeb";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "#444";
    ctx.fillRect(0, GROUND_Y + player.h, canvas.width, 40);

    ctx.fillStyle = "#ffcc00";
    ctx.fillRect(player.x, player.y, player.w, player.h);

    ctx.fillStyle = obstacle.color;
    ctx.fillRect(obstacle.x, obstacle.y, obstacle.w, obstacle.h);

    ctx.fillStyle = "#000";
    ctx.font = "18px Arial";
    ctx.fillText("Score: " + score, 10, 25);

    if (gameOver) {
        ctx.font = "32px Arial";
        ctx.fillText("Game Over", 310, 130);
        ctx.font = "18px Arial";
        ctx.fillText("Press Space to Restart", 290, 165);
    }
}

// ==================================================
// LOOP
// ==================================================
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>
