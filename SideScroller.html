<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JUMPR</title>
<style>
    body {
        margin: 0;
        background: #0b0b0b;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: Arial, sans-serif;
    }
    canvas {
        border: 3px solid white;
        background: black;
    }
</style>
</head>
<body>

<canvas id="game" width="800" height="300"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ==================================================
// AUDIO (CHROME-SAFE)
// ==================================================
let audioCtx;
let introOsc, gameOsc;
let audioUnlocked = false;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function stopMusic() {
    if (introOsc) introOsc.stop();
    if (gameOsc) gameOsc.stop();
    introOsc = gameOsc = null;
}

function startIntroMusic() {
    stopMusic();
    introOsc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    introOsc.type = "triangle";
    introOsc.frequency.value = 220;
    gain.gain.value = 0.07;
    introOsc.connect(gain).connect(audioCtx.destination);
    introOsc.start();
}

function startGameMusic() {
    stopMusic();
    gameOsc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    gameOsc.type = "sine";
    gameOsc.frequency.value = 140;
    gain.gain.value = 0.05;
    gameOsc.connect(gain).connect(audioCtx.destination);
    gameOsc.start();
}

function jumpSound() {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.setValueAtTime(300, audioCtx.currentTime);
    o.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.15);
    g.gain.setValueAtTime(0.3, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
    o.connect(g).connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + 0.2);
}

function crashSound() {
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.2, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
    const src = audioCtx.createBufferSource();
    src.buffer = buffer;
    src.connect(audioCtx.destination);
    src.start();
}

// ==================================================
// GAME CONSTANTS
// ==================================================
const GROUND_Y = 220;
// NEW (50% height, same airtime)
const GRAVITY = 0.225;
const JUMP_FORCE = -8.5;

// ==================================================
// STATE
// ==================================================
let gameStarted = false;
let gameOver = false;
let speed = 3;
let score = 0;
let time = 0;

// Player
const player = {
    x: 120,
    y: GROUND_Y,
    w: 40,
    h: 50,
    vy: 0,
    onGround: true,
    tilt: 0
};

// Background layers
let clouds = Array.from({length: 5}, () => ({
    x: Math.random() * canvas.width,
    y: 30 + Math.random() * 60,
    size: 20 + Math.random() * 20
}));

let cityX = 0;

// Obstacles
const obstacleTypes = [
    { w: 40, h: 35, color: "#7f8c8d" }, // gray rock
    { w: 50, h: 45, color: "#a97142" }, // brown boulder
    { w: 35, h: 60, color: "#556b2f" }, // tall mossy rock
    { w: 60, h: 30, color: "#8e5a2b" }  // flat stone
];

let obstacle;

// ==================================================
// INPUT
// ==================================================
document.addEventListener("keydown", e => {
    if (e.code !== "Space") return;

    initAudio();

    // First-ever key press → unlock audio + intro music
    if (!gameStarted && !audioUnlocked) {
        audioUnlocked = true;
        startIntroMusic();
    }

    if (!gameStarted) {
        gameStarted = true;
        stopMusic();
        resetGame();
        startGameMusic();
        return;
    }

    if (!gameOver && player.onGround) {
        player.vy = JUMP_FORCE;
        player.onGround = false;
        jumpSound();
    } else if (gameOver) {
        resetGame();
        startGameMusic();
    }
});

function resetGame() {
    gameOver = false;
    score = 0;
    speed = 3;
    player.y = GROUND_Y;
    player.vy = 0;
    player.onGround = true;
    obstacle = createObstacle();
}

function createObstacle() {
    const t = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
    return {
        x: canvas.width + 100,
        y: GROUND_Y + (player.h - t.h),
        w: t.w,
        h: t.h,
        color: t.color
    };
}

// ==================================================
// UPDATE
// ==================================================
function update() {
    time++;

    // ✅ Backgrounds ALWAYS move
    cityX -= 0.3;

    clouds.forEach(c => {
        c.x -= 0.2;
        if (c.x < -80) c.x = canvas.width + 80;
    });

    // ⛔ Stop here if gameplay isn't active
    if (!gameStarted || gameOver) return;

    // ======================
    // Gameplay logic only
    // ======================

    player.vy += GRAVITY;
    player.y += player.vy;

    if (player.y >= GROUND_Y) {
        player.y = GROUND_Y;
        player.vy = 0;
        player.onGround = true;
        player.tilt *= 0.8;
    } else {
        player.tilt = -0.3;
    }

    obstacle.x -= speed;

    if (obstacle.x + obstacle.w < player.x - 50) {
        score++;
        speed *= 1.05;
        obstacle = createObstacle();
    }

    // Collision detection
    if (
        player.x < obstacle.x + obstacle.w &&
        player.x + player.w > obstacle.x &&
        player.y < obstacle.y + obstacle.h &&
        player.y + player.h > obstacle.y
    ) {
        gameOver = true;
        stopMusic();
        crashSound();
        startIntroMusic();
    }
}

// ==================================================
// DRAW
// ==================================================
const CITY_SPACING = 100;

function drawCity() {
    ctx.save();
    ctx.globalAlpha = 0.35;

    const groundY = GROUND_Y + player.h;

    // Draw enough buildings to cover screen + buffer
    for (let i = -2; i < canvas.width / CITY_SPACING + 3; i++) {
        const x = i * CITY_SPACING + cityX;

        const width = 40 + (i % 3) * 20;
        const height = 90 + (i % 5) * 25;
        const topY = groundY - height;

        // Building body
        ctx.fillStyle = "#1f2433";
        ctx.fillRect(x, topY, width, height);

        // Windows
        for (let y = topY + 10; y < groundY - 10; y += 18) {
            for (let wx = x + 8; wx < x + width - 8; wx += 12) {
                if ((i + y + wx) % 4 === 0) {
                    ctx.fillStyle = Math.random() > 0.5
                        ? "rgba(255,220,140,0.5)"
                        : "rgba(180,220,255,0.45)";
                    ctx.fillRect(wx, y, 6, 8);
                }
            }
        }
    }

    ctx.restore();
}

function drawClouds() {
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    clouds.forEach(c => {
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.size, 0, Math.PI * 2);
        ctx.arc(c.x + c.size, c.y + 5, c.size * 0.8, 0, Math.PI * 2);
        ctx.fill();
    });
}

function drawPlayer() {
    ctx.save();
    ctx.translate(player.x + 20, player.y + 40);
    ctx.rotate(player.tilt);
    ctx.translate(-20, -40);

    // Skateboard
    ctx.fillStyle = "#2ecc71";
    ctx.beginPath();
    ctx.roundRect(0, 45, 60, 10, 5);
    ctx.fill();

    // Wheels
    ctx.fillStyle = "#111";
    ctx.beginPath();
    ctx.arc(10, 58, 4, 0, Math.PI * 2);
    ctx.arc(40, 58, 4, 0, Math.PI * 2);
    ctx.fill();

    // Legs
    ctx.fillStyle = "#1f5ed6";
    ctx.fillRect(18, 30, 6, 15);
    ctx.fillRect(28, 30, 6, 15);

    // Shirt
    ctx.fillStyle = "#fff";
    ctx.fillRect(14, 15, 24, 18);

    // Arms
    ctx.fillStyle = "#f2c9a0";
    ctx.fillRect(10, 17, 4, 14);
    ctx.fillRect(38, 17, 4, 14);

    // Head
    ctx.beginPath();
    ctx.arc(26, 8, 8, 0, Math.PI * 2);
    ctx.fill();

    // Backwards cap
    ctx.fillStyle = "#e53935";
    ctx.beginPath();
    ctx.arc(26, 6, 9, Math.PI, 0);
    ctx.fill();

    ctx.restore();
}

function drawObstacle(obs) {
    ctx.save();
    ctx.translate(obs.x + obs.w / 2, obs.y + obs.h / 2);

    ctx.fillStyle = obs.color;
    ctx.beginPath();

    // Rock-like shape
    ctx.moveTo(-obs.w / 2, obs.h / 4);
    ctx.quadraticCurveTo(0, -obs.h / 2, obs.w / 2, obs.h / 4);
    ctx.quadraticCurveTo(obs.w / 3, obs.h / 2, 0, obs.h / 2);
    ctx.quadraticCurveTo(-obs.w / 3, obs.h / 2, -obs.w / 2, obs.h / 4);

    ctx.fill();

    // Shading highlight
    ctx.globalAlpha = 0.25;
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.ellipse(-obs.w / 6, -obs.h / 6, obs.w / 6, obs.h / 8, 0, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();
}

function drawStartScreen() {
    ctx.fillStyle = "#0f2027";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const bounce = Math.sin(time * 0.05) * 6;
    ctx.fillStyle = "#fff";
    ctx.font = "72px Arial Black";
    ctx.fillText("JUMPR", 260, 140 + bounce);

    ctx.font = "20px Arial";
    ctx.globalAlpha = 0.6 + Math.sin(time * 0.1) * 0.4;
    ctx.fillText("Press Spacebar to Start", 265, 190);
    ctx.globalAlpha = 1;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (!gameStarted) {
        drawStartScreen();
        return;
    }

    ctx.fillStyle = "#87ceeb";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    drawCity();
    drawClouds();

    ctx.fillStyle = "#444";
    ctx.fillRect(0, GROUND_Y + player.h, canvas.width, 40);

    drawPlayer();

	drawObstacle(obstacle);

    ctx.fillStyle = "#000";
    ctx.font = "18px Arial";
    ctx.fillText("Score: " + score, 10, 25);

    if (gameOver) {
        ctx.font = "32px Arial";
        ctx.fillText("Game Over", 310, 130);
        ctx.font = "18px Arial";
        ctx.fillText("Press Space to Restart", 290, 165);
    }
}

// ==================================================
// LOOP
// ==================================================
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}


loop();
</script>

</body>
</html>
